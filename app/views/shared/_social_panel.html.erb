<div class="d-flex text-center">
  <% disable_buttons = current_user.present? ? false : true %>

  <%= form_with url: user_likes_path, method: :post, local: true, class: "flex-fill me-2" do |f| %>
    <%= f.hidden_field :movie_id, value: movie.id %>
    <%= f.hidden_field :user_id, value: current_user&.id %>
    <button type="submit" class="btn btn-light w-100 <%= 'disabled' if disable_buttons %>">
      <i class="bi bi-hand-thumbs-up"></i> <%= movie.movie_metric.likes_count %>
    </button>
  <% end %>

  <button class="btn btn-light flex-fill me-2 <%= 'disabled' if disable_buttons %>" 
          data-bs-toggle="<%= controller.action_name == "show" ? "expand" : "collapse" %>" 
          data-bs-target="#comments-panel">
    <i class="bi bi-chat-dots"></i> <%= movie.movie_metric.comments_count %>
  </button>

  <button class="btn btn-light flex-fill disabled">
    <i class="bi bi-eye"></i> <%= movie.movie_metric.views_count %>
  </button>
</div>
<div class="<%= controller.action_name == "show" ? "expand" : "collapse" %> mt-3" id="comments-panel">
  <div class="container my-4">
    <p style="color: green"><%= notice %></p>
    <!-- Comment / Reply Panel -->
    <div class="card shadow-sm">
      <div class="card-body">
        <%= form_with(model: [ movie, Comment.new ], local: true) do |form| %>
          <div class="mb-3">
            <%= form.text_area :content, class: "form-control", rows: 3, placeholder: "แสดงความคิดเห็นของคุณ..." %>
          </div>
          <%= hidden_field_tag :user_id, current_user&.id %>
          <%= form.submit "Reply", class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>
    <!-- Existing replies -->
    <div class="mt-3">
      <% movie.comments.order(created_at: :desc).each do |comment| %>
        <div class="card mb-2 shadow-sm">
          <div class="card-body">
            <p class="mb-1">
              <strong>
                <% if comment.user.present? %>
                  <%= comment.user.email %>
                <% else %>
                  guest
                <% end %>
                :
              </strong>
              <%= comment.content %>
            </p>
            <div class="d-flex align-items-center text-muted small">
              <i class="bi bi-clock me-1"></i>
              <span><%= time_ago_in_words(comment.created_at) %> ที่ผ่านมา</span>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
